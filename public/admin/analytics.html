<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - Walleyt Admin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0d1117;
        color: #c9d1d9;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        margin-bottom: 30px;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .nav-links {
        margin-bottom: 20px;
      }

      .nav-links a {
        color: #58a6ff;
        text-decoration: none;
        margin-right: 15px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #161b22;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #30363d;
      }

      .stat-label {
        font-size: 0.875rem;
        color: #8b949e;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #6366f1;
      }

      .chart-container {
        background: #161b22;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #30363d;
        margin-bottom: 20px;
      }

      .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #c9d1d9;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #161b22;
        border-radius: 12px;
        overflow: hidden;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #30363d;
      }

      th {
        background: #0d1117;
        color: #8b949e;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
      }

      .wallpaper-thumb {
        width: 40px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #8b949e;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <div class="nav-links">
        <a href="/admin"><i class="fas fa-arrow-left"></i> Back to Uploader</a>
      </div>

      <h1>ðŸ“Š Analytics Dashboard</h1>

      <!-- Stats Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Today's Visitors</div>
          <div class="stat-value" id="today-visitors">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Visitors (30d)</div>
          <div class="stat-value" id="total-visitors">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Downloads</div>
          <div class="stat-value" id="total-downloads">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Likes</div>
          <div class="stat-value" id="total-likes">-</div>
        </div>
      </div>

      <!-- Visitor Trends Chart -->
      <div class="chart-container">
        <div class="chart-title">Visitors Over Time</div>
        <canvas id="visitorChart"></canvas>
      </div>

      <!-- Top Wallpapers Table -->
      <div class="chart-container">
        <div class="chart-title">Top Wallpapers</div>
        <table id="topWallpapers">
          <thead>
            <tr>
              <th>Wallpaper</th>
              <th>Title</th>
              <th>Downloads</th>
              <th>Likes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="4" class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Top Categories -->
      <div class="chart-container">
        <div class="chart-title">Top Categories</div>
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      const API_URL = "http://localhost:3000/api/analytics";

      let visitorChart = null;
      let categoryChart = null;

      async function loadStats() {
        try {
          const response = await fetch(`${API_URL}/stats?days=30`);
          const data = await response.json();

          // Update stat cards
          document.getElementById("today-visitors").textContent =
            data.today.uniqueVisitors;
          document.getElementById("total-visitors").textContent =
            data.totals.uniqueVisitors;
          document.getElementById("total-downloads").textContent =
            data.totals.downloads;
          document.getElementById("total-likes").textContent =
            data.totals.likes;

          // Update visitor trend chart
          updateVisitorChart(data.timeline);

          // Update top wallpapers table
          updateTopWallpapers(data.topWallpapers);

          // Update category chart
          updateCategoryChart(data.topCategories);
        } catch (error) {
          console.error("Failed to load stats:", error);
        }
      }

      function updateVisitorChart(timeline) {
        const ctx = document.getElementById("visitorChart").getContext("2d");

        if (visitorChart) {
          visitorChart.destroy();
        }

        visitorChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: timeline.map((d) => d.date),
            datasets: [
              {
                label: "Unique Visitors",
                data: timeline.map((d) => d.visitors),
                borderColor: "#6366f1",
                backgroundColor: "rgba(99, 102, 241, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: "#c9d1d9" },
              },
            },
            scales: {
              x: {
                ticks: { color: "#8b949e" },
                grid: { color: "#30363d" },
              },
              y: {
                ticks: { color: "#8b949e" },
                grid: { color: "#30363d" },
                beginAtZero: true,
              },
            },
          },
        });
      }

      function updateTopWallpapers(wallpapers) {
        const tbody = document.querySelector("#topWallpapers tbody");

        if (!wallpapers || wallpapers.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" style="text-align: center; color: #8b949e;">No data yet</td></tr>';
          return;
        }

        tbody.innerHTML = wallpapers
          .map(
            (w) => `
                <tr>
                    <td><img src="${w.thumbnail}" class="wallpaper-thumb" alt="${w.title}"></td>
                    <td>${w.title}</td>
                    <td>${w.downloads}</td>
                    <td>${w.likes}</td>
                </tr>
            `
          )
          .join("");
      }

      function updateCategoryChart(categories) {
        const ctx = document.getElementById("categoryChart").getContext("2d");

        if (categoryChart) {
          categoryChart.destroy();
        }

        if (!categories || categories.length === 0) {
          return;
        }

        categoryChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: categories.map((c) => c.name),
            datasets: [
              {
                data: categories.map((c) => c.views),
                backgroundColor: [
                  "#6366f1",
                  "#8b5cf6",
                  "#06b6d4",
                  "#10b981",
                  "#f59e0b",
                  "#ef4444",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: "#c9d1d9" },
              },
            },
          },
        });
      }

      // Initial load
      loadStats();

      // Auto-refresh every 30 seconds
      setInterval(loadStats, 30000);
    </script>
  </body>
</html>
